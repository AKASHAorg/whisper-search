{"version":3,"sources":["../../src/handshake.js"],"names":["runService","installFilter","web3","filter","shh","topics","to","watch","err","message","post","from","identity","payload","ttl","fromDecimal","error","sent","console","log","newIdentity","address"],"mappings":";;;;;kBAyBwBA,U;;AAzBxB;;AAEA,IAAMC,gBAAgB,SAAhBA,aAAgB,CAACC,IAAD,EAAU;AAC9B,MAAMC,SAASD,KAAKE,GAAL,CAASD,MAAT,CAAgB,EAAEE,QAAQ,6BAAV,EAA+BC,IAAI,4BAAnC,EAAhB,CAAf;AACAH,SAAOI,KAAP,CAAa,UAACC,GAAD,EAAMC,OAAN,EAAkB;AAC7B,QAAI,CAACD,GAAL,EAAU;AACRN,WAAKE,GAAL,CACGM,IADH,CACQ;AACJC,cAAMC,QADF;AAEJN,YAAIG,QAAQE,IAFR;AAGJN,gBAAQ,8BAHJ;AAIJQ,iBAASJ,QAAQI,OAJb;AAKJC,aAAKZ,KAAKa,WAAL,CAAiB,EAAjB;AALD,OADR,EAOK,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAClB,YAAIA,IAAJ,EAAU;AACRC,kBAAQC,GAAR,CAAY,qBAAZ,EAAmCV,QAAQE,IAA3C;AACD,SAFD,MAEO;AACLO,kBAAQF,KAAR,CAAc,iBAAd,EAAiCA,KAAjC;AACD;AACF,OAbH;AAcD;AACF,GAjBD;AAkBA,SAAO,IAAP;AACD,CArBD;;AAuBe,SAAShB,UAAT,GAAuB;AACpC,MAAME,OAAO,wBAAb;;AAEA,MAAG,4BAAH,EAAiB;AACf,WAAOD,cAAcC,IAAd,CAAP;AACD;;AAEDA,OAAKE,GAAL,CAASgB,WAAT,CAAqB,UAACZ,GAAD,EAAMa,OAAN,EAAkB;AACrCH,YAAQC,GAAR,CAAY,mBAAZ,EAAiCE,OAAjC;AACA,+BAAYA,OAAZ;AACA,WAAOpB,eAAP;AACD,GAJD;AAKD","file":"handshake.js","sourcesContent":["import { getWeb3, getIdentity, setIdentity, HANDSHAKE_REQUEST, HANDSHAKE_RESPONSE } from './services';\n\nconst installFilter = (web3) => {\n  const filter = web3.shh.filter({ topics: [HANDSHAKE_REQUEST], to: getIdentity() });\n  filter.watch((err, message) => {\n    if (!err) {\n      web3.shh\n        .post({\n          from: identity,\n          to: message.from,\n          topics: [HANDSHAKE_RESPONSE],\n          payload: message.payload,\n          ttl: web3.fromDecimal(10)\n        }, (error, sent) => {\n          if (sent) {\n            console.log('Handshake done with', message.from);\n          } else {\n            console.error('Handshake error', error);\n          }\n        });\n    }\n  });\n  return null;\n};\n\nexport default function runService () {\n  const web3 = getWeb3();\n\n  if(getIdentity()){\n    return installFilter(web3);\n  }\n\n  web3.shh.newIdentity((err, address) => {\n    console.log('SERVICE IDENTITY ', address);\n    setIdentity(address);\n    return installFilter();\n  });\n}\n"]}